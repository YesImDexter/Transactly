<div class="deepfake-section">
    <h2>Deepfake Challenge</h2>
    <div class="video-frame">
        <img id="video-stream" src="{{ url_for('video') }}" style="width: 100%; background:#222;" />
    </div>
    <div class="challenge" id="challenge-text">Performing Challenge...</div>
    <div class="timer" id="countdown">Timer: 0s</div>
    <div class="progress-container"
        style="height: 8px; background-color: #1F2937; border-radius: 4px; margin: 10px 0; overflow: hidden;">
        <div id="timer-progress"
            style="height: 100%; width: 0%; background: linear-gradient(to right, #38BDF8, #8B5CF6); transition: width 0.1s linear;">
        </div>
    </div>
    <button class="proceed-btn" id="proceed-button">Proceed</button>
</div>

<script>
    const countdownEl = document.getElementById("countdown");
    const challengeText = document.getElementById("challenge-text");
    const proceedButton = document.getElementById("proceed-button");
    let elapsed = 0;
    let interval = null;

    window.onload = () => {
        const CHALLENGE_DURATION = 3; // 3 seconds for challenge completion

        interval = setInterval(() => {
            fetch("/challenge-status")
                .then(res => res.json())
                .then(data => {
                    const challengeMap = {
                        "peace_sign": "Challenge: Hold a peace sign for 3 seconds",
                        "high_five": "Challenge: Show a high five for 3 seconds",
                        "thumbs_up": "Challenge: Give a thumbs up for 3 seconds",
                        "rock_sign": "Challenge: Show a rock sign for 3 seconds"
                    };

                    challengeText.innerText = challengeMap[data.challenge] || "Performing Challenge...";

                    if (data.success) {
                        proceedButton.classList.add("success");
                        challengeText.innerText = "âœ… Challenge Passed!";
                        countdownEl.style.color = "green";
                        countdownEl.innerText = "Timer: " + CHALLENGE_DURATION + "s";
                        document.getElementById("timer-progress").style.width = "100%";
                        clearInterval(interval);
                        // Enable proceed button and add click handler
                        proceedButton.addEventListener("click", function () {
                            window.location.href = "/fingerprint";
                        });
                    } else {
                        if (data.start_time) {
                            elapsed = Math.floor((Date.now() - data.start_time) / 1000);
                            // Ensure we don't exceed the challenge duration
                            elapsed = Math.min(elapsed, CHALLENGE_DURATION);
                            countdownEl.innerText = "Timer: " + elapsed + "s";

                            // Update progress bar
                            const progressPercent = (elapsed / CHALLENGE_DURATION) * 100;
                            document.getElementById("timer-progress").style.width = progressPercent + "%";
                        } else {
                            elapsed = 0;
                            countdownEl.innerText = "Timer: 0s";
                            document.getElementById("timer-progress").style.width = "0%";
                        }
                    }
                });
        }, 1000);
    };
</script>